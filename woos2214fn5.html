<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Web Office OS 2.2.14</title>
    <style>
        /* --------------------------------- */
        /* 1. –ü–ê–õ–ò–¢–†–ê –ò –°–¢–ò–õ–¨ (Web Office / Windows 10 Hybrid) */
        /* --------------------------------- */
        :root {
            --win-bg: #E4EBF5; /* –§–æ–Ω —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞ */
            --win-accent: #0078D4; /* –û—Å–Ω–æ–≤–Ω–æ–π —Å–∏–Ω–∏–π –∞–∫—Ü–µ–Ω—Ç */
            --win-panel: #F3F3F3; /* –§–æ–Ω –æ–∫–æ–Ω, –º–µ–Ω—é (—Å–≤–µ—Ç–ª—ã–π) */
            --win-dark: #333333; /* –¢–µ–∫—Å—Ç –∏ –∏–∫–æ–Ω–∫–∏ */
            --win-light-text: #333333; /* –Ø–≤–Ω—ã–π —á–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å–≤–µ—Ç–ª–æ–º —Ñ–æ–Ω–µ */
            --win-border: #CCCCCC; /* –¶–≤–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã */
            --win-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* –ú—è–≥–∫–∞—è —Ç–µ–Ω—å */
            --win-glass: rgba(255, 255, 255, 0.9); /* –ê–∫—Ä–∏–ª (–ø–æ—á—Ç–∏ –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π) */
            --win-hover: rgba(0, 0, 0, 0.08);

            --bg: var(--win-bg);--panel: var(--win-panel);--glass: var(--win-glass);--accent: var(--win-accent);
        }

        /* –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê */
        [data-theme="dark"] {
            --win-bg: #1F1F1F;
            --win-panel: #2B2B2B;
            --win-dark: #EFEFEF; /* –°–≤–µ—Ç–ª—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
            --win-light-text: #EFEFEF; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç –≤ –º–µ–Ω—é */
            --win-border: #444444;
            --win-accent: #3A96DD;
            --win-glass: rgba(43, 43, 43, 0.9);
            --win-hover: rgba(255, 255, 255, 0.1);
        }
        /* –ù–ï–û–ù–û–í–ê–Ø –¢–ï–ú–ê */
        [data-theme="neon"] {
            --win-accent: #ff2d95;
            --win-bg: #04030a;
            --win-panel: #0a0e14;
            --win-dark: #cbd5e1;
            --win-light-text: #cbd5e1;
            --win-border: #222233;
            --win-glass: rgba(10, 14, 20, 0.9);
            --win-hover: rgba(255, 45, 149, 0.15);
        }
        /* --------------------------------- */

        * { box-sizing: border-box; }
        html, body {
            height: 100%; margin: 0; font-family: 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg); color: var(--win-dark); transition: background-color 0.3s, color 0.3s;
        }
        body { overflow: hidden; }

        /* Desktop & Icons */
        #desktop {
            position: relative;
            width: 100%;
            height: calc(100vh - 40px);
            overflow: hidden;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s;
        }
        .icon {
            width: 92px; text-align: center; font-size: 13px;
            color: var(--win-dark);
            cursor: pointer; position: absolute; padding: 8px 4px; border-radius: 4px; transition: background 0.1s;
        }
        .icon:hover { background: var(--win-hover); }
        .icon div:first-child { font-size: 40px; margin-bottom: 4px; }

        /* Taskbar (Windows 10 Style) */
        #taskbar {
            position: fixed; left: 0; bottom: 0; width: 100%; height: 40px;
            background: var(--win-glass); border-top: 1px solid var(--win-border);
            display: flex; align-items: center; padding: 0 4px; box-shadow: var(--win-shadow);
            z-index: 60; backdrop-filter: blur(8px);
        }
        #startBtn {
            width: 40px; height: 40px; border-radius: 0;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.15s;
        }
        #startBtn:hover { background: var(--win-hover); }
        #startBtn.active { background: var(--win-accent); color: white; }
        #startBtn .logo { font-size: 20px; font-weight: bold; }

        /* Taskbar Items */
        #taskItems { display: flex; gap: 2px; align-items: center; margin-left: 5px;}
        .taskItem { padding: 4px 10px; height: 32px; border-radius: 2px; background: transparent; cursor: pointer; color: var(--win-dark); transition: background 0.15s; display: flex; align-items: center;}
        .taskItem.active { background: var(--win-accent); color: white; }

        /* Start Menu (Windows 10 Style) */
        #startMenu {
            position: fixed; left: 0; bottom: 40px;
            background: var(--win-panel); width: 400px;
            height: 500px;
            padding: 10px 0;
            box-shadow: var(--win-shadow);
            border: 1px solid var(--win-border);
            display: none;
            z-index: 9999;
            backdrop-filter: blur(6px);
            display: flex; flex-direction: column;
        }
        .appList { padding: 10px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; overflow-y: auto; flex: 1; }
        .appCard {
            background: var(--win-hover); padding: 10px; border-radius: 4px; text-align: left;
            cursor: pointer; transition: background 0.12s; display: flex; align-items: center; justify-content: space-between;
            color: var(--win-light-text);
        }
        .appCard:hover { background: var(--win-accent); color: white; }
        .appCard div:first-child { font-size: 20px; margin-right: 8px; }
        .appCard button { color: var(--win-dark) !important; }
        .appCard:hover button { color: white !important; }

        /* Window (Back to simple) */
        .window {
            position: absolute; background: var(--win-panel); border-radius: 0;
            border: 1px solid var(--win-border); box-shadow: var(--win-shadow);
            overflow: hidden; display: flex; flex-direction: column;
            z-index: 100; min-width: 200px; min-height: 100px;
        }
        .titlebar {
            height: 30px; display: flex; align-items: center; padding: 0 8px;
            gap: 8px; background: var(--win-panel); border-bottom: 1px solid var(--win-border);
            cursor: grab; flex-shrink: 0;
        }
        .controls { margin-left: auto; display: flex; }

        .controls .btn {
            height: 30px; width: 40px; font-size: 14px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .controls .btn:hover { background: var(--win-hover); }
        .controls .btn[data-act="close"]:hover {
            background: #E81123;
            color: white;
        }

        .content {
            padding: 10px; flex: 1; overflow: auto;
            background: var(--win-panel);
            display: flex; flex-direction: column;
            color: var(--win-dark);
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        /* Other elements */
        button, select, input, textarea {
            padding: 6px 10px; border-radius: 2px; border: 1px solid var(--win-border);
            background: white;
            color: black;
            transition: border-color 0.15s;
        }

        [data-theme="dark"] button:not(.accent-btn),
        [data-theme="dark"] select,
        [data-theme="dark"] input:not([type="color"]),
        [data-theme="dark"] textarea {
             background: #3a3a3a;
             border-color: #555555;
             color: var(--win-dark);
        }


        #editorArea {
             color: #000000 !important; /* –ß–ï–†–ù–´–ô –¢–ï–ö–°–¢ */
             background: #FFFFFF !important; /* –ë–ï–õ–´–ô –§–û–ù –ü–û–õ–Ø */
        }
        /* –ö–û–ù–ï–¶ –ì–ê–†–ê–ù–¢–ò–ò */


        .accent-btn { background: var(--win-accent) !important; color: white !important; border-color: var(--win-accent) !important; font-weight: 600; }
        .accent-btn:hover { background: #0063B1 !important; }
        #desktopClock {
            position: relative; top: 0; right: 0; color: var(--win-dark); font-weight: 600; z-index: 50;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ (–¥–ª—è —á–∏—Å—Ç–æ—Ç—ã) */
        .calc-btn {
            padding: 15px 5px; font-size: 1.2em; border: none; border-radius: 0; cursor: pointer;
            background: #E0E0E0; color: black; transition: background 0.1s;
        }
        .calc-btn:hover { background: #D0D0D0; }
        .calc-btn[data-type="operator"], .calc-btn[data-val="="] { background: #FF9800; color: white; }
        .calc-btn[data-val="="]:hover { background: #E68900; }
        .calc-btn[data-val="C"], .calc-btn[data-val="<-"] { background: #FFCCBC; color: black; }

        /* –°—Ç–∏–ª—å –¥–ª—è –∑–º–µ–π–∫–∏ */
        #gameInfo {
            display: flex; justify-content: space-between; padding: 5px 10px; background: var(--win-hover); border-radius: 4px; margin-bottom: 10px;
        }
    </style>
</head>
<body data-theme="light">
    <div id="desktop"></div>

    <div id="startMenu" role="menu" style="display: none;">
        <div style="padding: 0 10px 10px; border-bottom: 1px solid var(--win-border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
            <h3 style="margin:0; color: var(--win-dark);">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
        </div>
        <div class="appList" id="appGrid"></div>
    </div>

    <div id="taskbar">
        <div id="startBtn" title="–ü—É—Å–∫">
            <span class="logo">‚ùñ</span>
        </div>
        <div id="taskItems"></div>
        <div style="flex: 1;"></div>
        <div id="tray" style="display:flex;gap:8px;align-items:center; padding-right: 10px;">
            <div id="desktopClock"></div>
        </div>
    </div>

    <input id="fileLoader" type="file" style="display:none" />
    <input id="musicLoader" type="file" accept="audio/*" style="display:none" />
    <input id="bgLoader" type="file" accept="image/*" style="display:none" />

    <script>
    /* ---------------------------------
        2. JS: –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò –ú–ï–ù–ï–î–ñ–ú–ï–ù–¢ (Local Storage File System)
        --------------------------------- */

    const $ = sel => document.querySelector(sel);
    const desktop = $('#desktop');
    const startMenu = $('#startMenu');
    const startBtn = $('#startBtn');
    const appGrid = $('#appGrid');
    const taskItems = $('#taskItems');
    const OS_VERSION = 'WebOfficeOS_2_2_14'; // –í–µ—Ä—Å–∏—è 2.2.14

    let z = 100;

    // --- LocalStorage File System Helpers (Unchanged) ---
    const LS_KEY = OS_VERSION + '_FS';
    const LS_THEMES = OS_VERSION + '_THEMES';
    const LS_APPS = OS_VERSION + '_APPS';

    function loadFS() {
        try { return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); }
        catch (e) { console.error("Error loading FS from LS", e); return {}; }
    }

    function saveFS(fs) { localStorage.setItem(LS_KEY, JSON.stringify(fs)); }

    function putItem(item) {
        const fs = loadFS();
        if (!item || !item.id) return null;
        if (item.id in fs) {
            fs[item.id] = { ...fs[item.id], ...item };
        } else {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º mime –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
            if (!item.mime && item.type === 'file') {
                 item.mime = item.name.endsWith('.txt') ? 'text/plain' : (item.name.endsWith('.png') || item.name.endsWith('.jpg') ? 'image/png' : 'application/octet-stream');
            }
            fs[item.id] = item;
        }
        saveFS(fs);
        return fs[item.id];
    }
    function getItem(id) { const fs = loadFS(); return fs[id]; }
    function listChildren(parent) { const fs = loadFS(); return Object.values(fs).filter(item => item.parent === parent); }

    function deleteItem(id) {
        if (!id || id === 'root' || id === 'docs' || id === 'pics') return false;
        const fs = loadFS();
        delete fs[id];
        Object.keys(fs).forEach(key => {
            if (fs[key].parent === id) delete fs[key];
        });
        saveFS(fs);
        renderDesktop();
        return true;
    }
    // ------------------------------------

    // --- APP MANAGEMENT (Unchanged) ---

    let BUILT_IN_APPS = [
        {id:'files',name:'–ü—Ä–æ–≤–æ–¥–Ω–∏–∫',icon:'üìÅ',fn:openFiles},
        {id:'viewer', name:'–ü—Ä–æ—Å–º–æ—Ç—Ä –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π', icon:'üèûÔ∏è', fn: openImageViewer, isSystem: true},
        {id:'editor',name:'–¢–µ–∫—Å—Ç',icon:'üìù',fn:()=>openTextEditor()},
        {id:'paint',name:'Paint',icon:'üé®',fn:openPaint},
        {id:'browser',name:'–ë—Ä–∞—É–∑–µ—Ä',icon:'üåê',fn:openBrowser},
        {id:'music',name:'–ú—É–∑—ã–∫–∞',icon:'üéµ',fn:openMusic},
        {id:'calendar',name:'–ö–∞–ª–µ–Ω–¥–∞—Ä—å',icon:'üìÖ',fn:openCalendar},
        {id:'settings',name:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏',icon:'‚öôÔ∏è',fn:openSettings},
        {id:'calc',name:'–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä',icon:'üßÆ',fn:openCalculator},
        {id:'table',name:'–¢–∞–±–ª–∏—Ü—ã',icon:'üìä',fn:openSpreadsheet},
        {id:'about',name:'–û —Å–∏—Å—Ç–µ–º–µ',icon:'üí°',fn:openAbout},
        {id:'addApp',name:'+ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',icon:'‚ûï',fn:openAppCreator, isSystem: true}
    ];

    function loadDynamicApps() {
        try { return JSON.parse(localStorage.getItem(LS_APPS) || '[]'); }
        catch (e) { return []; }
    }

    function saveDynamicApps(apps) {
        localStorage.setItem(LS_APPS, JSON.stringify(apps));
    }

    function addApp(name, icon, htmlContent, jsCode, id=null){
        const dynamicApps = loadDynamicApps();
        const newAppId = id || 'app_'+Date.now();
        const existingIndex = dynamicApps.findIndex(app => app.id === newAppId);

        const newApp = {
            id: newAppId,
            name, icon,
            isDynamic: true,
            html: htmlContent,
            js: jsCode
        };

        if(existingIndex > -1) {
            dynamicApps[existingIndex] = newApp; // –û–±–Ω–æ–≤–ª—è–µ–º
        } else {
            dynamicApps.push(newApp); // –î–æ–±–∞–≤–ª—è–µ–º
        }

        saveDynamicApps(dynamicApps);
        renderStartMenu();
    }

    function deleteApp(id) {
        let dynamicApps = loadDynamicApps();
        dynamicApps = dynamicApps.filter(app => app.id !== id);
        saveDynamicApps(dynamicApps);
        renderStartMenu();
    }

    function getAppList() {
        const dynamicApps = loadDynamicApps().map(app => ({
            ...app,
            fn: () => {
                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –æ–∫–Ω–∞ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
                let w = 600;
                let h = 400;

                // --- –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –†–ê–ó–ú–ï–† –î–õ–Ø –ó–ú–ï–ô–ö–ò ---
                if(app.name.toLowerCase().includes('–∑–º–µ–π–∫–∞') || app.id === 'snake_game') {
                    w = 420;
                    h = 500;
                }
                // --------------------------------------------------------

                const {win, content} = createWindow(app.name, w, h);

                content.innerHTML = app.html;
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é new Function –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –∫–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                    const func = new Function('content', 'createWindow', 'window', 'document', 'win', app.js);
                    func.call(content, content, createWindow, window, document, win);
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞: ' + e.message);
                }
            }
        }));
        return BUILT_IN_APPS.concat(dynamicApps);
    }

    // --- Initialization and Rendering (Snake App Code Unchanged) ---

    const SNAKE_HTML = `
        <div id="gameInfo">
            <span>–°—á–µ—Ç: <span id="score">0</span></span>
            <button id="startGameBtn" class="accent-btn" style="padding: 4px 8px;">–°—Ç–∞—Ä—Ç</button>
        </div>
        <canvas id="snakeCanvas" width="400" height="400" style="border: 1px solid #000; display: block; margin: 0 auto; background: #C8E6C9;"></canvas>
        <p style="text-align: center; margin-top: 5px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä–µ–ª–∫–∏ (‚Üë‚Üì‚Üê‚Üí) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.</p>
    `;

    const SNAKE_JS = `
        const canvas = content.querySelector('#snakeCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = content.querySelector('#score');
        const startButton = content.querySelector('#startGameBtn');

        const TILE_SIZE = 20;
        const GRID_SIZE = canvas.width / TILE_SIZE;

        let snake = [{x: 10, y: 10}];
        let food = {};
        let dx = TILE_SIZE;
        let dy = 0;
        let score = 0;
        let gameLoopId;
        let gameRunning = false;

        // --- Game Logic ---

        function drawTile(x, y, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            ctx.strokeStyle = '#eee';
            ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        }

        function generateFood() {
            food.x = Math.floor(Math.random() * GRID_SIZE);
            food.y = Math.floor(Math.random() * GRID_SIZE);
            // –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ–¥–∞ –Ω–µ –Ω–∞ –∑–º–µ–π–∫–µ
            for (let part of snake) {
                if (part.x === food.x && part.y === food.y) {
                    generateFood();
                    return;
                }
            }
        }

        function moveSnake() {
            const head = {x: snake[0].x + dx / TILE_SIZE, y: snake[0].y + dy / TILE_SIZE};

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å–æ —Å—Ç–µ–Ω–∞–º–∏
            if (head.x < 0 || head.x >= GRID_SIZE || head.y < 0 || head.y >= GRID_SIZE) {
                gameOver();
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å —Å–æ–±–æ–π
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    gameOver();
                    return;
                }
            }

            snake.unshift(head);

            // –ï–¥–∞?
            if (head.x === food.x && head.y === food.y) {
                score++;
                scoreElement.textContent = score;
                generateFood();
            } else {
                snake.pop(); // –£–¥–∞–ª–∏—Ç—å —Ö–≤–æ—Å—Ç
            }
        }

        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#C8E6C9';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // –ó–º–µ–π–∫–∞
            snake.forEach((part, index) => {
                drawTile(part.x, part.y, index === 0 ? '#1A4314' : '#4CAF50'); // –¢–µ–º–Ω–∞—è –≥–æ–ª–æ–≤–∞
            });

            // –ï–¥–∞
            drawTile(food.x, food.y, '#FF5252');
        }

        function mainLoop() {
            if (!gameRunning) return;

            moveSnake();
            drawGame();

            // –°–∫–æ—Ä–æ—Å—Ç—å –∏–≥—Ä—ã –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–ª–∏–Ω—ã –∑–º–µ–π–∫–∏
            let speed = 100 - (score * 5);
            speed = Math.max(speed, 50); // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å

            gameLoopId = setTimeout(mainLoop, speed);
        }

        function gameOver() {
            gameRunning = false;
            clearTimeout(gameLoopId);
            ctx.font = "30px Arial";
            ctx.fillStyle = "red";
            ctx.textAlign = "center";
            ctx.fillText("–ò–≥—Ä–∞ –û–∫–æ–Ω—á–µ–Ω–∞!", canvas.width / 2, canvas.height / 2);
            ctx.font = "16px Arial";
            ctx.fillStyle = "black";
            ctx.fillText("–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: " + score, canvas.width / 2, canvas.height / 2 + 30);
            startButton.textContent = '–ù–∞—á–∞—Ç—å –°–Ω–æ–≤–∞';
            startButton.disabled = false;
        }

        function startGame() {
            if (gameRunning) return;

            snake = [{x: 10, y: 10}];
            dx = TILE_SIZE;
            dy = 0;
            score = 0;
            scoreElement.textContent = score;
            gameRunning = true;
            startButton.textContent = '–í –ò–≥—Ä–µ...';
            startButton.disabled = true;

            generateFood();
            mainLoop();
        }

        // --- Event Listeners ---

        const handleKeyDown = (e) => {
            // NOTE: win –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑-–∑–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –≤ new Function
            const allWindows = Array.from(document.querySelectorAll('.window'));
            const maxZIndex = Math.max(...allWindows.map(w => parseInt(w.style.zIndex) || 0));
            if (!gameRunning || win.style.zIndex !== String(maxZIndex)) return;

            const goingUp = dy === -TILE_SIZE;
            const goingDown = dy === TILE_SIZE;
            const goingRight = dx === TILE_SIZE;
            const goingLeft = dx === -TILE_SIZE;

            if (e.key === 'ArrowLeft' && !goingRight) {
                dx = -TILE_SIZE; dy = 0;
            } else if (e.key === 'ArrowUp' && !goingDown) {
                dx = 0; dy = -TILE_SIZE;
            } else if (e.key === 'ArrowRight' && !goingLeft) {
                dx = TILE_SIZE; dy = 0;
            } else if (e.key === 'ArrowDown' && !goingUp) {
                dx = 0; dy = TILE_SIZE;
            }
        };

        document.addEventListener('keydown', handleKeyDown);
        startButton.addEventListener('click', startGame);

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–∫–Ω–∞
        win.addEventListener('remove', () => {
            document.removeEventListener('keydown', handleKeyDown);
            clearTimeout(gameLoopId);
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        ctx.font = "30px Arial";
        ctx.fillStyle = "gray";
        ctx.textAlign = "center";
        ctx.fillText("–ù–∞–∂–º–∏—Ç–µ –°–¢–ê–†–¢", canvas.width / 2, canvas.height / 2);
    `;

    function ensureDemo() {
        const fs = loadFS();
        if (Object.keys(fs).length < 5) {
            const initialFiles = [
                { id: 'root', name: '/', type: 'folder', parent: null },
                { id: 'docs', name: 'Documents', type: 'folder', parent: 'root' },
                { id: 'pics', name: 'Pictures', type: 'folder', parent: 'root' },
                { id: 'welcome', name: 'Welcome.txt', type: 'file', parent: 'docs', content: 'Web Office OS 2.2.14: –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "–ó–º–µ–π–∫–∞" –≤ –º–µ–Ω—é –ü—É—Å–∫!', mime: 'text/plain' }
            ];
            initialFiles.forEach(putItem);
        }

        // --- –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –°–û–ó–î–ê–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø "–ó–ú–ï–ô–ö–ê" ---
        const existingApps = loadDynamicApps();
        const snakeExists = existingApps.some(app => app.id === 'snake_game');

        if (!snakeExists) {
            addApp('–ó–º–µ–π–∫–∞', 'üêç', SNAKE_HTML, SNAKE_JS, 'snake_game');
        }
        // ----------------------------------------------------

        renderDesktop();
        renderStartMenu();
        applySettings();
    }

    // --- Window Manager (–ò–°–•–û–î–ù–ê–Ø –í–ï–†–°–ò–Ø - –ü–ï–†–ï–¢–ê–°–ö–ò–í–ê–ù–ò–ï –¢–û–õ–¨–ö–û –ó–ê–ì–û–õ–û–í–ö–ê) ---
    function createWindow(title,w=700,h=480,left=120,top=80){
        const win=document.createElement('div');
        win.className='window';
        win.style.width=w+'px';
        win.style.height=h+'px';
        win.style.left=left+'px';
        win.style.top=top+'px';
        win.style.zIndex=++z;
        win.dataset.title=title;
        win.innerHTML=`<div class='titlebar'><div class='title' style='flex: 1;'>${title}</div><div class='controls'><div class='btn' data-act='min'>‚Äî</div><div class='btn' data-act='max'>&#9723;</div><div class='btn' data-act='close'>‚úï</div></div></div><div class='content'></div>`;
        document.body.appendChild(win);

        const titlebar=win.querySelector('.titlebar');
        const content=win.querySelector('.content');

        win.addEventListener('mousedown', ()=>{win.style.zIndex=++z});

        // ----------------------------------------------------------------
        // –õ–û–ì–ò–ö–ê DRAGGING (–°–¢–ê–†–ê–Ø - –¢–û–õ–¨–ö–û –ó–ê–ì–û–õ–û–í–û–ö)
        // ----------------------------------------------------------------
        let drag=false, dx=0, dy=0;
        titlebar.addEventListener('mousedown', (e) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞–∂–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if (e.target.closest('.controls')) return;

            drag = true;
            dx = e.clientX - win.offsetLeft;
            dy = e.clientY - win.offsetTop;
            win.style.zIndex = ++z;
            e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        });

        window.addEventListener('mousemove', (e) => {
            if (!drag) return;

            // –ï—Å–ª–∏ –æ–∫–Ω–æ –º–∞–∫—Å–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ, –Ω–µ –¥–≤–∏–≥–∞–µ–º –µ–≥–æ
            if(win.dataset.max === '1') return;

            win.style.left = (e.clientX - dx) + 'px';
            win.style.top = (e.clientY - dy) + 'px';
        });

        window.addEventListener('mouseup', () => {
            drag = false;
        });
        // ----------------------------------------------------------------

        const controls = win.querySelector('.controls');

        controls.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn');
            if (!btn) return;

            const action = btn.dataset.act;

            if (action === 'close') {
                if(win._task) win._task.remove();
                // –í—ã–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ, —á—Ç–æ–±—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–æ–≥–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å —Å–ª—É—à–∞—Ç–µ–ª–∏
                const removeEvent = new CustomEvent('remove', { bubbles: true });
                win.dispatchEvent(removeEvent);

                win.remove();
            }
            else if (action === 'min') {
                win.style.display='none';
                if(win._task) win._task.classList.remove('active');
            }
            else if (action === 'max') {
                if(win.dataset.max==='1'){
                    // Restore
                    win.style.width=win.dataset.w;win.style.height=win.dataset.h;
                    win.style.left=win.dataset.l;win.style.top=win.dataset.t;
                    win.dataset.max='0';
                }else{
                    // Maximize
                    win.dataset.w=win.style.width;win.dataset.h=win.style.height;
                    win.dataset.l=win.style.left;win.dataset.t=win.style.top;

                    win.style.left='0';win.style.top='0';
                    win.style.width=window.innerWidth+'px';
                    win.style.height=(window.innerHeight-40)+'px';
                    win.dataset.max='1';
                }
            }
        });

        titlebar.addEventListener('dblclick', (e) => {
            if (!e.target.closest('.controls')) {
                const maxBtn = win.querySelector('[data-act="max"]');
                if (maxBtn) maxBtn.click();
            }
        });

        addTask(win, title);

        return {win,content};
    }

    function addTask(win,title){
        const el=document.createElement('div');
        el.className='taskItem active';
        el.textContent=title.length > 15 ? title.substring(0, 12) + '...' : title;
        el.onclick=()=>{
            if(win.style.display==='none'){
                win.style.display='flex';
                el.classList.add('active');
                win.style.zIndex=++z;
            }
            else if(win.style.zIndex === z){
                win.style.display='none';
                el.classList.remove('active');
            }
            else {
                win.style.zIndex=++z;
                el.classList.add('active');
            }
        };
        taskItems.appendChild(el);
        win._task=el;
    }

    function renderStartMenu(){
        appGrid.innerHTML='';
        const appList = getAppList();
        const sortedApps = [...appList].sort((a, b) => a.name.localeCompare(b.name));

        sortedApps.forEach(a=>{
            const card=document.createElement('div');
            card.className='appCard';

            const infoDiv = document.createElement('div');
            infoDiv.style.display = 'flex';
            infoDiv.style.alignItems = 'center';
            infoDiv.innerHTML = `<div>${a.icon}</div><div>${a.name}</div>`;
            infoDiv.onclick=()=>{startMenu.style.display='none';startBtn.classList.remove('active');a.fn()};

            card.appendChild(infoDiv);

            if (a.isDynamic && !a.isSystem) {
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '‚ùå';
                deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ';
                deleteBtn.style.cssText = 'padding: 4px; background: none; border: none; font-size: 16px; cursor: pointer;';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "${a.name}"?`)) {
                        deleteApp(a.id);
                    }
                };
                card.appendChild(deleteBtn);
            }

            appGrid.appendChild(card)
        })
    }

    // --- Desktop Rendering and Icon Drag Logic (Unchanged) ---
    function renderDesktop(path='root'){
        desktop.innerHTML='';
        const items=listChildren(path);
        let i=0;
        for(const it of items){
            const el=document.createElement('div');
            el.className='icon';
            el.dataset.id=it.id;

            let x = it.desktopX !== undefined ? it.desktopX : (20 + (i%6)*110);
            let y = it.desktopY !== undefined ? it.desktopY : (20 + Math.floor(i/6)*120);

            el.style.left=x+'px';
            el.style.top=y+'px';

            el.draggable=true;
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            const icon = it.type==='folder' ? 'üìÅ' : (it.mime && it.mime.startsWith('image/') ? 'üñºÔ∏è' : 'üìÑ');
            el.innerHTML=`<div style='font-size:46px'>${icon}</div><div style='max-width:88px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap'>${it.name}</div>`;

            el.addEventListener('dblclick',()=>{
                if(it.type==='folder'){
                    openFolderWindow(it.id,it.name)
                } else {
                    openFileByType(it.id); // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
                }
            });
            desktop.appendChild(el);i++;

            // Logic for dragging
            let isDragging = false;
            let offsetX, offsetY;

            el.addEventListener('pointerdown', (e) => {
                if (e.target.tagName.toLowerCase() === 'div' && e.target.closest('.icon')) {
                    isDragging = true;
                    e.preventDefault();
                    el.setPointerCapture(e.pointerId);
                    offsetX = e.clientX - el.offsetLeft;
                    offsetY = e.clientY - el.offsetTop;
                    el.style.zIndex = ++z;
                }
            });

            el.addEventListener('pointermove', (e) => {
                if (!isDragging) return;
                let newX = e.clientX - offsetX;
                let newY = e.clientY - offsetY;

                const grid = 10;
                newX = Math.round(newX / grid) * grid;
                newY = Math.round(newY / grid) * grid;

                el.style.left = newX + 'px';
                el.style.top = newY + 'px';
            });

            el.addEventListener('pointerup', () => {
                if (isDragging) {
                    isDragging = false;
                    const itemToSave = getItem(it.id);
                    itemToSave.desktopX = el.offsetLeft;
                    itemToSave.desktopY = el.offsetTop;
                    putItem(itemToSave);
                }
            });
        }
    }

    // --- Core File Handler (Unchanged) ---

    function openFileByType(id) {
        const item = getItem(id);
        if (!item) return;

        if (item.mime && item.mime.startsWith('text/')) {
            openTextEditor(id);
        } else if (item.mime && item.mime.startsWith('image/')) {
            openImageViewer(id);
        } else {
            alert(`–ù–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–∞ —Ç–∏–ø–∞ ${item.mime || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}!`);
        }
    }

    // --- Theme & Start Menu Logic (Unchanged) ---
    const THEMES = ['light', 'dark', 'neon'];
    const BACKGROUNDS = [
        {name: 'Default Wave', type: 'color', value: 'var(--win-bg)'},
        {name: 'Stars', type: 'url', value: 'https://images.unsplash.com/photo-1534796636680-302ac8594251?fit=crop&w=1280&h=720&q=80'},
        {name: 'City Light', type: 'url', value: 'https://images.unsplash.com/photo-1549419137-b7654a8e239b?fit=crop&w=1280&h=720&q=80'},
    ];

    function saveSettings(key, value) {
        localStorage.setItem(OS_VERSION + '_' + key, value);
    }

    function getSettings(key, defaultValue) {
        return localStorage.getItem(OS_VERSION + '_' + key) || defaultValue;
    }

    function applySettings(){
        const savedTheme = getSettings('theme', 'light');
        document.body.dataset.theme = savedTheme;

        const savedBgType = getSettings('bg_type', 'color');
        const savedBgValue = getSettings('bg_value', 'var(--win-bg)');

        if (savedBgType === 'color') {
            desktop.style.backgroundImage = 'none';
            desktop.style.backgroundColor = savedBgValue;
        } else if (savedBgType === 'url') {
            desktop.style.backgroundImage = `url('${savedBgValue}')`;
            desktop.style.backgroundColor = 'var(--win-bg)';
        } else if (savedBgType === 'data') {
            desktop.style.backgroundImage = `url('${savedBgValue}')`;
            desktop.style.backgroundColor = 'var(--win-bg)';
        }
    }

    startBtn.onclick=()=>{
        const isVisible = startMenu.style.display==='flex';
        startMenu.style.display = isVisible ? 'none' : 'flex';
        startBtn.classList.toggle('active', !isVisible);
    };
    window.addEventListener('click',e=>{if(!startMenu.contains(e.target) && e.target!==startBtn && !startBtn.contains(e.target)){startMenu.style.display='none'; startBtn.classList.remove('active')}})

    // --- App Implementations (Unchanged) ---
    // (openFiles, openFolderWindow, openImageViewer, openTextEditor, openPaint, openSettings, openBrowser, openMusic, openCalendar, openCalculator, openSpreadsheet, openAbout)

    function openFiles(){openFolderWindow('root', '–ü—Ä–æ–≤–æ–¥–Ω–∏–∫');}
    function openFolderWindow(id,name){
        const {win,content}=createWindow(name,600,420,160,120);
        content.innerHTML=`<div style='display:flex;gap:8px;margin-bottom:12px; flex-shrink: 0;'><button id='newFile' class='accent-btn'>–ù–æ–≤—ã–π —Ñ–∞–π–ª</button><button id='newFolder'>–ù–æ–≤–∞—è –ø–∞–ø–∫–∞</button></div><div id='list' style='flex: 1; overflow-y: auto;'></div>`;
        const list=content.querySelector('#list');
        function refresh(){
            const items=listChildren(id);
            list.innerHTML='';
            if (id !== 'root') {
                 const upRow = document.createElement('div');
                 upRow.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding: 6px; border-bottom: 1px solid #CCC; font-style: italic; background: var(--win-hover); cursor: pointer;';
                 upRow.innerHTML = `<div>‚¨ÜÔ∏è ..</div><button>–ù–∞–≤–µ—Ä—Ö</button>`;
                 upRow.querySelector('button').onclick = () => {
                     const currentItem = getItem(id);
                     if (currentItem && currentItem.parent) {
                         const parentItem = getItem(currentItem.parent);
                         openFolderWindow(currentItem.parent, parentItem.name);
                         win.remove();
                     }
                 };
                 list.appendChild(upRow);
            }
            for(const it of items){
                const icon = it.type==='folder' ? 'üìÅ' : (it.mime && it.mime.startsWith('image/') ? 'üñºÔ∏è' : 'üìÑ');
                const row=document.createElement('div');
                row.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding: 6px; border-bottom: 1px solid #EEE;';
                row.innerHTML=`<div style='display:flex;gap:10px;align-items:center'><div>${icon}</div><div style='min-width:140px'>${it.name}</div></div><div><button data-open='${it.id}'>–û—Ç–∫—Ä—ã—Ç—å</button><button data-delete='${it.id}' style='margin-left: 5px; color: red;'>–£–¥–∞–ª–∏—Ç—å</button></div>`;
                list.appendChild(row);
            }
            list.querySelectorAll('[data-open]').forEach(b=>b.onclick=()=>{
                const it=getItem(b.getAttribute('data-open'));
                if(it.type==='folder'){openFolderWindow(it.id,it.name); win.remove();}
                else{openFileByType(it.id)} // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
            });

            list.querySelectorAll('[data-delete]').forEach(b=>b.onclick=()=>{
                const deleteId = b.getAttribute('data-delete');
                const item = getItem(deleteId);
                if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å "${item.name}"?`)) {
                    deleteItem(deleteId);
                    refresh();
                }
            });
        }
        content.querySelector('#newFile').onclick=()=>{const name=prompt('–ò–º—è —Ñ–∞–π–ª–∞','untitled.txt');if(name){putItem({id:'f_'+Date.now(),name,type:'file',parent:id,content:'',mime:'text/plain'});refresh()}};
        content.querySelector('#newFolder').onclick=()=>{const name=prompt('–ò–º—è –ø–∞–ø–∫–∏','–ù–æ–≤–∞—è –ø–∞–ø–∫–∞');if(name){putItem({id:'d_'+Date.now(),name,type:'folder',parent:id});refresh()}};
        refresh();
    }

    // üèûÔ∏è Image Viewer
    function openImageViewer(id = null) {
        const item = getItem(id);
        if (!item || !item.content || !item.mime.startsWith('image/')) {
            const {win, content} = createWindow('–ü—Ä–æ—Å–º–æ—Ç—Ä –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π', 600, 400);
            content.innerHTML = `<p style="text-align: center; margin-top: 50px;">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</p>`;
            return;                                                                                               –≤–∏—Ç–µ–ª–µ–Ω
        }

        const {win, content} = createWindow(item.name, 700, 500, 180, 140);
        content.style.padding = '0';
        content.style.overflow = 'hidden';
        content.innerHTML = `
            <div style="flex: 1; display: flex; justify-content: center; align-items: center; background: #000;">
                <img src="${item.content}" alt="${item.name}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
            </div>
        `;
    }

    // üìù Text Editor
    function openTextEditor(id=null){
        let initial='', name='';
        const item = getItem(id);
        if(item){initial=item.content||'';name=item.name||'file.txt'}
        const {win,content}=createWindow(name||'–¢–µ–∫—Å—Ç–æ–≤—ã–π –†–µ–¥–∞–∫—Ç–æ—Ä',760,520,140,90);

        content.innerHTML=`
            <div style='display:flex;gap:8px;margin-bottom:12px; flex-shrink: 0;'>
                <input id='fname' placeholder='–∏–º—è —Ñ–∞–π–ª–∞.txt' value='${name||''}' style='flex:1;'/>
                <button id='saveBtn' class='accent-btn'>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <textarea id='editorArea' style='width:100%;flex:1;resize:none;border:1px solid var(--win-border);padding:10px;min-height: 350px;'>${initial}</textarea>
        `;

        content.querySelector('#saveBtn').onclick=()=>{
            const n=content.querySelector('#fname').value||('untitled_'+Date.now()+'.txt');
            const c=content.querySelector('#editorArea').value;
            let mime = 'text/plain';
            if (n.endsWith('.html') || n.endsWith('.htm')) mime = 'text/html';

            if(id){
                const it=getItem(id);
                it.content=c;it.name=n; it.mime=mime;
                putItem(it);
            }else{
                putItem({id:'f_'+Date.now(),name:n,type:'file',parent:'root',content:c,mime:mime});
            }
            win.querySelector('.title').textContent=n;
            alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
            renderDesktop();
        };
    }

    // üé® Paint
    function openPaint(){
        const {win, content}=createWindow('Paint',760,540,160,120);
        content.style.padding = '0';
        content.innerHTML=`
            <div style='display:flex;gap:10px;padding:8px; flex-shrink: 0; align-items: center;'>
                <label style='color: var(--win-dark);'>–¶–≤–µ—Ç: <input type='color' id='colorPicker' value='#000000'/></label>
                <label style='color: var(--win-dark);'>–†–∞–∑–º–µ—Ä: <input type='range' id='sizeRange' min='1' max='50' value='5'/></label>
                <button id='clearBtn'>–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button id='savePngBtn' class='accent-btn'>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ –≤ –ø–∞–ø–∫—É Pictures</button>
            </div>
            <canvas id='paintCanvas' width='758' height='470' style='border:none;background:white; cursor: crosshair; flex-shrink: 1;'></canvas>
        `;

        const canvas = content.querySelector('#paintCanvas');
        const ctx = canvas.getContext('2d');
        const colorPicker = content.querySelector('#colorPicker');
        const sizeRange = content.querySelector('#sizeRange');
        content.querySelector('#clearBtn').onclick = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

        content.querySelector('#savePngBtn').onclick = () => {
             try {
                const dataURL = canvas.toDataURL('image/png');
                const name=prompt('–ò–º—è —Ä–∏—Å—É–Ω–∫–∞','drawing_'+Date.now()+'.png');
                if(name){
                    putItem({
                        id:'img_'+Date.now(),
                        name: name,
                        type: 'file',
                        parent: 'pics',
                        content: dataURL,
                        mime: 'image/png'
                    });
                    alert(`–†–∏—Å—É–Ω–æ–∫ "${name}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ø–∞–ø–∫—É Pictures!`);
                    renderDesktop();
                }
             } catch (e) {
                 alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message + ' (–í–æ–∑–º–æ–∂–Ω–æ, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞)');
             }
        };

        let isDrawing = false;
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        });
        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.strokeStyle = colorPicker.value;
            ctx.lineWidth = sizeRange.value;
            ctx.lineCap = 'round';
            ctx.stroke();
        });
        canvas.addEventListener('mouseup', () => { isDrawing = false; });
        canvas.addEventListener('mouseout', () => { isDrawing = false; });
    }

    // ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    function openSettings(){
        const {win, content}=createWindow('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –û–°', 550, 480, 200, 100);
        content.innerHTML=`
            <h3 style='border-bottom: 1px solid var(--win-border); padding-bottom: 5px;'>‚öôÔ∏è –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <div style='display: grid; grid-template-columns: 150px 1fr; gap: 15px;'>

                <h4>üé® –¢–µ–º–∞</h4>
                <select id="themeSelect">
                    ${THEMES.map(t => `<option value="${t}">${t.charAt(0).toUpperCase() + t.slice(1)}</option>`).join('')}
                </select>

                <h4>üñºÔ∏è –§–æ–Ω</h4>
                <select id="bgSelect" style="flex: 1;">
                    ${BACKGROUNDS.map((bg, i) => `<option value="${bg.type}:${bg.value}">${bg.name}</option>`).join('')}
                </select>

                <h4></h4>
                <div>
                    <button id="loadBgBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–π —Ñ–æ–Ω</button>
                    <button id="clearBgBtn" style="margin-left: 10px; color: red;">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ–Ω</button>
                </div>

                <h4>üõ†Ô∏è –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞</h4>
                <button id="resetFS" style="background: #F44336; color: white;">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –û–°</button>

                <h4 style="grid-column: span 2; border-bottom: 1px solid var(--win-border); margin-top: 15px;">–ü—Ä–æ—á–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–∑–∞–≥–ª—É—à–∫–∏)</h4>

                <h4>–ó–≤—É–∫–∏</h4>
                <input type="range" min="0" max="100" value="50">

                <h4>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h4>
                <input type="checkbox" checked>

            </div>
        `;

        const themeSelect = content.querySelector('#themeSelect');
        const bgSelect = content.querySelector('#bgSelect');
        const loadBgBtn = content.querySelector('#loadBgBtn');
        const clearBgBtn = content.querySelector('#clearBgBtn');
        const resetFSBtn = content.querySelector('#resetFS');
        const bgLoader = $('#bgLoader');

        themeSelect.value = getSettings('theme', 'light');
        bgSelect.value = getSettings('bg_type', 'color') + ':' + getSettings('bg_value', 'var(--win-bg)');

        themeSelect.onchange = (e) => {
            const newTheme = e.target.value;
            saveSettings('theme', newTheme);
            applySettings();
        };

        bgSelect.onchange = (e) => {
            const [type, value] = e.target.value.split(':');
            saveSettings('bg_type', type);
            saveSettings('bg_value', value);
            applySettings();
        };

        loadBgBtn.onclick = () => bgLoader.click();
        bgLoader.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    const name = 'Custom BG';

                    saveSettings('bg_type', 'data');
                    saveSettings('bg_value', dataUrl);
                    applySettings();

                    alert('–í–∞—à —Ñ–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω!');

                    const option = document.createElement('option');
                    option.value = 'data:' + dataUrl;
                    option.textContent = name;
                    bgSelect.appendChild(option);
                    bgSelect.value = 'data:' + dataUrl;
                };
                reader.readAsDataURL(file);
            }
            bgLoader.value = null;
        };

        clearBgBtn.onclick = () => {
            saveSettings('bg_type', 'color');
            saveSettings('bg_value', 'var(--win-bg)');
            bgSelect.value = 'color:var(--win-bg)';
            applySettings();
        };

        resetFSBtn.onclick = () => {
            if (confirm('–í–ù–ò–ú–ê–ù–ò–ï! –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –í–°–Æ —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É (—Ñ–∞–π–ª—ã, –ø–∞–ø–∫–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)?')) {
                localStorage.clear();
                alert('–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.');
                win.remove();
            }
        };
    }

    function openBrowser(){
        const {content}=createWindow('–ë—Ä–∞—É–∑–µ—Ä',900,600,80,60);
        content.style.padding = '0';
        content.innerHTML=`<div style='display:flex;padding:8px; background: var(--win-panel); border-bottom: 1px solid var(--win-border); flex-shrink: 0;'><input id='url' placeholder='https://example.com' style='flex:1;' value='https://gemini.google.com/'/><button id='go' class='accent-btn'>Go</button></div><iframe id='iframe' style='width:100%;flex:1;border:none;background: white;'></iframe>`;
        const url=content.querySelector('#url');
        const iframe=content.querySelector('#iframe');
        iframe.src=url.value;
        content.querySelector('#go').onclick=()=>{let u=url.value.trim();if(!u) return; if(!/^https?:\/\//.test(u)) u='https://'+u;iframe.src=u};
    }

    function openMusic(){
        const {content}=createWindow('–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ü–ª–µ–µ—Ä',640,420,220,120);
        content.innerHTML=`
            <div style='display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; gap: 15px;'>
                <audio id='audioPlayer' controls style='width:90%; flex-shrink: 0;'>
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç.
                </audio>
                <div id='currentTrackInfo' style='font-style: italic;'>–¢—Ä–µ–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</div>
                <button id='loadMusicBtn' class='accent-btn'>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¢—Ä–µ–∫ (MP3, WAV)</button>
            </div>
        `;

        const audioPlayer = content.querySelector('#audioPlayer');
        const trackInfo = content.querySelector('#currentTrackInfo');
        const loadMusicBtn = content.querySelector('#loadMusicBtn');
        const musicLoader = $('#musicLoader');

        loadMusicBtn.onclick = () => musicLoader.click();

        musicLoader.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                audioPlayer.src = url;
                trackInfo.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${file.name}`;
                audioPlayer.play();
            }
            musicLoader.value = null;
        };
    }
    function openCalendar(){
        const {content}=createWindow('–ö–∞–ª–µ–Ω–¥–∞—Ä—å',400,460,260,180);
        content.innerHTML=`<div id="calendarDisplay" style="text-align: center;"></div>`;

        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();
        const day = today.getDate();

        function renderCalendar(m, y) {
            const firstDayOfMonth = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
            const weekDays = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"];

            let html = `
                <h3 style="color: var(--win-accent); margin-bottom: 5px;">${monthNames[m]} ${y}</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead><tr>${weekDays.map(d => `<th style="padding: 5px; color: #666;">${d}</th>`).join('')}</tr></thead>
                    <tbody>
            `;

            let date = 1;
            let firstDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;

            for (let i = 0; i < 6; i++) {
                html += '<tr>';
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < firstDay) {
                        html += '<td></td>';
                    } else if (date > daysInMonth) {
                        html += '<td></td>';
                    } else {
                        const isToday = (date === day && m === today.getMonth() && y === today.getFullYear());
                        const style = isToday ? `background: var(--win-accent); color: white; border-radius: 50%; font-weight: bold;` : ``;
                        html += `<td style="padding: 8px; text-align: center;"><span style="${style}">${date}</span></td>`;
                        date++;
                    }
                }
                html += '</tr>';
            }
            html += '</tbody></table>';
            content.querySelector('#calendarDisplay').innerHTML = html;
        }

        renderCalendar(month, year);
    }

    // üßÆ Calculator
    function openCalculator(){
        const {content}=createWindow('–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä',320,400,300,100);
        content.style.padding = '15px';
        content.innerHTML=`
            <input type="text" id="calcDisplay" value="0" style="width:100%; height:50px; text-align:right; font-size:2em; margin-bottom:10px; padding: 0 10px; border: 1px solid #AAA;" readonly>
            <div id="calcPad" style="display:grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                <button data-val="C" class="calc-btn">C</button><button data-val="/" data-type="operator" class="calc-btn">/</button><button data-val="*" data-type="operator" class="calc-btn">*</button><button data-val="<-" class="calc-btn">‚å´</button>
                <button data-val="7" class="calc-btn">7</button><button data-val="8" class="calc-btn">8</button><button data-val="9" class="calc-btn">9</button><button data-val="-" data-type="operator" class="calc-btn">-</button>
                <button data-val="4" class="calc-btn">4</button><button data-val="5" class="calc-btn">5</button><button data-val="6" class="calc-btn">6</button><button data-val="+" data-type="operator" class="calc-btn">+</button>
                <button data-val="1" class="calc-btn">1</button><button data-val="2" class="calc-btn">2</button><button data-val="3" class="calc-btn">3</button><button data-val="=" class="calc-btn accent-btn" style="grid-row: span 2;">=</button>
                <button data-val="0" class="calc-btn" style="grid-column: span 2;">0</button><button data-val="." class="calc-btn">.</button>
            </div>
        `;
        const display = content.querySelector('#calcDisplay');
        let currentInput = '0';
        let firstOperand = null;
        let operator = null;
        let waitingForSecondOperand = false;

        function updateDisplay() {
            display.value = currentInput;
        }

        function inputDigit(digit) {
            if (waitingForSecondOperand) {
                currentInput = digit;
                waitingForSecondOperand = false;
            } else {
                currentInput = currentInput === '0' ? digit : currentInput + digit;
            }
            updateDisplay();
        }

        function inputDecimal(dot) {
            if (waitingForSecondOperand) {
                currentInput = '0' + dot;
                waitingForSecondOperand = false;
                updateDisplay();
                return;
            }
            if (!currentInput.includes(dot)) {
                currentInput += dot;
            }
            updateDisplay();
        }

        function handleOperator(nextOperator) {
            const inputValue = parseFloat(currentInput);

            if (operator && waitingForSecondOperand) {
                operator = nextOperator;
                return;
            }

            if (firstOperand === null) {
                firstOperand = inputValue;
            } else if (operator) {
                const result = operate(firstOperand, inputValue, operator);
                currentInput = String(result);
                firstOperand = result;
            }

            waitingForSecondOperand = true;
            operator = nextOperator;
            updateDisplay();
        }

        function resetCalculator() {
            currentInput = '0';
            firstOperand = null;
            operator = null;
            waitingForSecondOperand = false;
            updateDisplay();
        }

        function clearEntry() {
            currentInput = currentInput.slice(0, -1) || '0';
            updateDisplay();
        }

        function operate(first, second, op) {
            if (op === '+') return first + second;
            if (op === '-') return first - second;
            if (op === '*') return first * second;
            if (op === '/') {
                if (second === 0) {
                    alert('–û—à–∏–±–∫–∞: –î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å');
                    return 0;
                }
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
                return Math.round((first / second) * 10000) / 10000;
            }
            return second;
        }

        content.querySelector('#calcPad').addEventListener('click', (e) => {
            const btn = e.target.closest('.calc-btn');
            if (!btn) return;
            const val = btn.dataset.val;

            if (['+', '-', '*', '/'].includes(val)) {
                handleOperator(val);
            } else if (val === '=') {
                handleOperator('=');
                operator = null;
            } else if (val === 'C') {
                resetCalculator();
            } else if (val === '<-') {
                clearEntry();
            } else if (val === '.') {
                inputDecimal(val);
            } else {
                inputDigit(val);
            }
        });

        // Initialize display
        updateDisplay();
    }


    function openSpreadsheet(){
        const {content}=createWindow('–¢–∞–±–ª–∏—Ü—ã',900,600,80,60);
        content.style.padding = '0';
        content.innerHTML=`
            <div style='display:flex;gap:10px;padding:8px; border-bottom: 1px solid var(--win-border); flex-shrink: 0;'>
                <input placeholder='A1' style='width: 60px; text-align: center;' readonly>
                <input placeholder='Fx (–§–æ—Ä–º—É–ª–∞)' style='flex: 1;'>
                <button class='accent-btn'>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <div id='spreadsheetGrid' style='overflow: auto; flex: 1;'>
                <table style='width: 100%; border-collapse: collapse; min-width: 880px;'>
                    <thead>
                        <tr>
                            <th style='width:30px; border: 1px solid #CCC; background: #EEE; color: black;'></th>
                            ${'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').map(l => `<th style='width:80px; border: 1px solid #CCC; background: #EEE; text-align: center; color: black;'>${l}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${Array(20).fill(0).map((_, r) => `
                            <tr>
                                <td style='width:30px; border: 1px solid #CCC; background: #EEE; text-align: center; font-weight: bold; color: black;'>${r + 1}</td>
                                ${Array(26).fill(0).map(() => `
                                    <td style='border: 1px solid #CCC;'><input type='text' value='' style='width: 100%; border: none; padding: 4px; background: transparent;'></td>
                                `).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            <p style='padding: 5px 10px; margin: 0; font-size: 0.8em; color: #888;'>–≠—Ç–æ –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¢–∞–±–ª–∏—Ü—ã. –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç.</p>
        `;
    }

    // üí° About
    function openAbout(){
        const {content}=createWindow('–û —Å–∏—Å—Ç–µ–º–µ: Web Office OS',400,300,300,200);
        content.innerHTML=`
            <div style="text-align: center; padding: 20px;">
                <h3 style="margin-top: 0; color: var(--win-accent);">Web Office OS</h3>
                <p style="font-size: 1.2em; font-weight: bold;">–í–µ—Ä—Å–∏—è: 2.2.14:FN5</p>
                <p>–ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:02:11:2025  </p>
                <p style="margin-top: 20px; font-style: italic;">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: <span style="font-weight: bold;">K8</span></p>
            </div>
        `;
    }

    function openAppCreator(){
        const {win, content} = createWindow('–î–æ–±–∞–≤–∏—Ç—å –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', 800, 600, 100, 100);
        content.style.padding = '0';

        let appNameValue = '–ú–æ–µ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ';
        let appIconValue = 'üåü';
        let appHtmlValue = `<p>–ü—Ä–∏–≤–µ—Ç –æ—Ç –Ω–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!</p>\n<button id="testBtn">–¢–µ—Å—Ç</button>`;
        let appJsValue = `// 'content' - —ç—Ç–æ DOM-—ç–ª–µ–º–µ–Ω—Ç –æ–∫–Ω–∞\n// 'win' - —ç—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –æ–∫–Ω–∞\ncontent.querySelector('#testBtn').onclick = () => {\n    alert('–ö–Ω–æ–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!');\n};\n\n// –ß—Ç–æ–±—ã –æ–∫–Ω–æ –ó–º–µ–π–∫–∏ –±—ã–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–º—è '–ó–º–µ–π–∫–∞'.`;

        // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–æ–º –ó–º–µ–π–∫–∏, –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞
        const hasCustomApp = loadDynamicApps().length > 0;
        if (!hasCustomApp) {
             appNameValue = '–ó–º–µ–π–∫–∞';
             appIconValue = 'üêç';
             appHtmlValue = SNAKE_HTML;
             appJsValue = SNAKE_JS.replace(/const win = content.closest\('.window'\);/g, '// const win –¥–æ—Å—Ç—É–ø–µ–Ω –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç —Ñ—É–Ω–∫—Ü–∏–∏-–æ–±–µ—Ä—Ç–∫–∏.');
        }

        content.innerHTML = `
            <div style="padding: 15px; background: var(--win-panel); border-bottom: 1px solid var(--win-border); flex-shrink: 0;">
                <div style="display:flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <label>–ò–º—è: <input id='appName' value='${appNameValue}' style='width:150px'/></label>
                    <label>–ò–∫–æ–Ω–∫–∞: <input id='appIcon' value='${appIconValue}' style='width:50px'/></label>
                    <button id='createAppBtn' class='accent-btn'>–°–æ–∑–¥–∞—Ç—å –∏ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
            <div style="display:flex; height: 100%; flex: 1; overflow: hidden;">
                <div style="flex: 1; padding: 10px; border-right: 1px solid var(--win-border); display: flex; flex-direction: column;">
                    <h4 style="margin-top:0; flex-shrink: 0;">HTML (–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–∫–Ω–∞)</h4>
                    <textarea id='appHtml' style='width:100%; flex: 1; resize: none; font-family: monospace; white-space: pre;'>${appHtmlValue}</textarea>
                </div>
                <div style="flex: 1; padding: 10px; display: flex; flex-direction: column;">
                    <h4 style="margin-top:0; flex-shrink: 0;">JavaScript (–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)</h4>
                    <textarea id='appJs' style='width:100%; flex: 1; resize: none; font-family: monospace; white-space: pre;'>${appJsValue}</textarea>
                </div>
            </div>
        `;

        content.querySelector('#createAppBtn').onclick = () => {
            const name = content.querySelector('#appName').value;
            const icon = content.querySelector('#appIcon').value;
            const html = content.querySelector('#appHtml').value;
            const js = content.querySelector('#appJs').value;

            addApp(name, icon, html, js);
            win.remove();
            alert(`–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "${name}" –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –º–µ–Ω—é "–ü—É—Å–∫"!`);

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            const app = getAppList().find(a => a.name === name);
            if (app) app.fn();
        };

        // –õ–æ–≥–∏–∫–∞ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –æ–∫–Ω–∞
        const appNameInput = content.querySelector('#appName');
        appNameInput.addEventListener('input', () => {
             const name = appNameInput.value.toLowerCase();
             // –ï—Å–ª–∏ –∏–º—è –ø–æ—Ö–æ–∂–µ –Ω–∞ "–ó–º–µ–π–∫–∞" - –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º
             if (name.includes('–∑–º–µ–π–∫–∞') || name.includes('snake')) {
                 alert('–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏–º—è "–ó–º–µ–π–∫–∞"! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω–æ –≤ –æ–∫–Ω–µ 420x500.');
             }
        });
    }

    // Clock
    const clockEl=$('#desktopClock');
    function updateClock(){clockEl.textContent=new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}
    setInterval(updateClock,1000);updateClock();

    // initialize
    (async ()=>{ensureDemo();})();
    </script>
</body>
</html>